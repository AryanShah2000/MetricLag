<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Industry Impacts on Spot Rates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root{
      --bg:#0b1220; --panel:#102033; --text:#e8eefc; --muted:#a9b8d9;
      --aqua:#dff7f7; --grid:#74b6c0; --purple:#4b34db; --teal:#20a5b3; --border:#1c3559;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text);}
    header{padding:16px 18px 4px}
    h1{margin:0; font-size:20px; font-weight:700; letter-spacing:.2px}
    .wrap{display:grid; grid-template-columns:300px 1fr; gap:14px; padding:10px 16px 16px;}
    .panel{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px; max-height:78vh; overflow:auto;}
    .panel h2{margin:0 0 10px 0; font-size:12px; color:var(--muted); font-weight:700; text-transform:uppercase; letter-spacing:.4px}
    .controls{display:flex; gap:8px; margin-bottom:8px}
    button{background:#183056; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:6px 10px; font-size:12px; cursor:pointer}
    button:hover{border-color:#345aa3}
    .metric{display:flex; align-items:center; gap:8px; padding:6px 6px; border-radius:8px;}
    .metric:hover{background:#0f223d}
    .legend{display:flex; gap:14px; align-items:center; margin:6px 0 2px; font-size:12px; color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%}
    .pos{background:var(--purple)} .neg{background:var(--teal)}
    .plot{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:10px; display:flex; align-items:center; justify-content:center;}
    #chart{width:720px; height:720px; margin:0 auto;}
    .foot{padding:6px 18px 14px; color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <header><h1>Industry Impacts on Spot Rates</h1></header>

  <div class="wrap">
    <aside class="panel">
      <h2>Filters</h2>
      <div class="controls">
        <button id="selectAll">Select all</button>
        <button id="selectNone">None</button>
      </div>
      <div class="legend">
        <span class="dot pos"></span> Upward Impact
        <span class="dot neg"></span> Downward Impact
      </div>
      <div id="metricList" style="margin-top:6px;"></div>
    </aside>

    <main class="plot"><div id="chart"></div></main>
  </div>

  <div class="foot">
    Square plot • Bubbles spread via rank-based x-scale (non-linear) • Purple = upward, Teal = downward
  </div>

<script>
/* ==== Data (internal only; UI shows just names) ==== */
const METRICS = [
  {name:"M2 Money Supply (FRED)", r2:0.236, lag:6,  coef:  1.2981},
  {name:"Active Carriers (FMCSA)", r2:0.207, lag:11, coef: -2.4419},
  {name:"Housing Starts (FRED)",   r2:0.205, lag:11, coef:  0.1405},
  {name:"Class 8 Inventory",       r2:0.198, lag:6,  coef: -0.4929},
  {name:"Industrial Production (FRED)", r2:0.198, lag:6, coef:-0.7167},
  {name:"Truck Tonnage (FRED)",    r2:0.187, lag:7,  coef: -0.9492},
  {name:"Class 8 Gross",           r2:0.185, lag:11, coef:  0.1272},
  {name:"Class 8 Retail Sales",    r2:0.169, lag:6,  coef: -0.0950},
  {name:"Freight TSI (FRED)",      r2:0.167, lag:7,  coef: -1.0589},
  {name:"Trucking Ton-Mile",       r2:0.165, lag:6,  coef: -0.7095},
  {name:"Carrier Authority Granted", r2:0.160, lag:10, coef:0.1312},
  {name:"Carrier Authority Revoked", r2:0.159, lag:11, coef:-0.1445},
  {name:"Money Supply (FRED)",     r2:0.150, lag:11, coef: 0.0474},
  {name:"CHR Routing Guide Depth", r2:0.146, lag:4,  coef: 0.1058},
  {name:"Carrier Authority Reinstated", r2:0.141, lag:8, coef:0.4015},
  {name:"Imports",                 r2:0.139, lag:11, coef: 0.3097},
  {name:"Class 8 Next",            r2:0.134, lag:12, coef: 0.0705},
  {name:"ISM Manufacturing Index", r2:0.133, lag:10, coef:0.2426},
  {name:"CRB Commodity Index",     r2:0.124, lag:8,  coef:-0.1785},
  {name:"U.S. Diesel Prices",      r2:0.122, lag:6,  coef:-0.2861},
  {name:"Class 8 Build (ACT)",     r2:0.121, lag:7,  coef:-0.0526},
  {name:"Class 8 Cancels",         r2:0.105, lag:12, coef:-0.0375},
  {name:"Advanced Retail Sales (FRED)", r2:0.104, lag:11, coef:0.2122},
  {name:"PPI (Final Demand)",      r2:0.102, lag:3,  coef: 1.6429},
  {name:"S&P GSCI (Commodities)",  r2:0.101, lag:6,  coef:-0.1896},
  {name:"ISM New Orders",          r2:0.097, lag:10, coef:0.0704},
  {name:"Carrier Authority — Net", r2:0.093, lag:6,  coef:0.0009},
  {name:"Bloomberg Commodity Index", r2:0.073, lag:7, coef:-0.1853},
  {name:"Inventory-to-Sales Ratio (FRED)", r2:0.065, lag:11, coef:-0.3021},
  {name:"Class 8 Backlogs",        r2:0.053, lag:8,  coef:-0.4928}
];

/* ==== Checklist (names only) ==== */
const listEl = document.getElementById('metricList');
METRICS.forEach((m,i)=>{
  const row = document.createElement('label'); row.className = 'metric';
  const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=true; cb.dataset.index=i;
  const txt = document.createElement('span'); txt.textContent = m.name;
  row.appendChild(cb); row.appendChild(txt); listEl.appendChild(row);
});
document.getElementById('selectAll').onclick = ()=>{
  document.querySelectorAll('#metricList input[type=checkbox]').forEach(cb=>cb.checked=true); render();
};
document.getElementById('selectNone').onclick = ()=>{
  document.querySelectorAll('#metricList input[type=checkbox]').forEach(cb=>cb.checked=false); render();
};

/* ==== Helpers for non-linear spreading ==== */
function rankScale(values){
  // map each value to its rank percentile (1..N)/(N+1); ties share same spot
  const s=[...values].sort((a,b)=>a-b);
  const map=new Map();
  s.forEach((v,i)=>{ if(!map.has(v)) map.set(v,(i+1)/(s.length+1)); });
  return values.map(v=>map.get(v));
}
function jitter(n,amp=0.015){ return Array.from({length:n},()=> (Math.random()-0.5)*2*amp); }

/* ==== Render square plot ==== */
function render(){
  const sel=[];
  document.querySelectorAll('#metricList input[type=checkbox]').forEach(cb=>{
    if(cb.checked) sel.push(METRICS[Number(cb.dataset.index)]);
  });

  const pos = sel.filter(m=>m.coef>=0);
  const neg = sel.filter(m=>m.coef<0);

  // --- Build non-linear x via rank of |coef|; normalize y via lag ---
  const allLags = METRICS.map(m=>m.lag);
  const yMin = Math.min(...allLags), yMax = Math.max(...allLags);

  const buildTrace = (arr,colorVar)=>{
    const absVals = arr.map(m=>Math.abs(m.coef));
    const xRank = rankScale(absVals);
    const x = xRank.map((v,i)=> Math.min(0.97, Math.max(0.03, v + jitter(1)[0]))); // a bit of jitter + clamp
    const y = arr.map(m=> (m.lag - yMin)/(yMax - yMin) ).map(v=> 0.05 + 0.90*v);    // keep some padding
    return {
      x, y,
      text: arr.map(m=>m.name),
      mode:'markers+text',
      type:'scatter',
      name: colorVar==='--purple' ? 'Upward Impact' : 'Downward Impact',
      hovertemplate:'%{text}<extra></extra>',
      textposition:'top center',
      textfont:{size:11, color:'#1b2a3d'},
      marker:{
        size: arr.map(m=> 16 + 28*(m.r2/Math.max(0.001,...sel.map(s=>s.r2)))),
        color: getComputedStyle(document.documentElement).getPropertyValue(colorVar).trim(),
        line:{color:'rgba(0,0,0,0.25)', width:1}
      }
    };
  };

  const layout = {
    width:720, height:720, // perfect square
    paper_bgcolor:'rgba(0,0,0,0)',
    plot_bgcolor:getComputedStyle(document.documentElement).getPropertyValue('--aqua').trim(),
    font:{color:getComputedStyle(document.documentElement).getPropertyValue('--text').trim()},
    margin:{l:60,r:30,t:20,b:60},
    xaxis:{title:'', range:[0,1], showticklabels:false, ticks:'', showgrid:false, zeroline:false},
    yaxis:{title:'', range:[0,1], showticklabels:false, ticks:'', showgrid:false, zeroline:false},
    shapes:[
      {type:'line', x0:0.5, x1:0.5, y0:0.05, y1:0.95,
       line:{color:getComputedStyle(document.documentElement).getPropertyValue('--grid').trim(), width:2, dash:'dot'}},
      {type:'line', x0:0.03, x1:0.97, y0:0.5, y1:0.5,
       line:{color:getComputedStyle(document.documentElement).getPropertyValue('--grid').trim(), width:2, dash:'dot'}}
    ],
    annotations:[
      {xref:'paper', yref:'paper', x:0.01, y:0.02, text:'Immediate Effect', showarrow:false, font:{size:12, color:'#1b2a3d'}},
      {xref:'paper', yref:'paper', x:0.01, y:0.98, text:'Delayed Effect',   showarrow:false, font:{size:12, color:'#1b2a3d'}},
      {xref:'paper', yref:'paper', x:0.02, y:0.0, text:'Low Impact',  showarrow:false, yshift:-14, font:{size:12, color:'#1b2a3d'}},
      {xref:'paper', yref:'paper', x:0.98, y:0.0, text:'High Impact', showarrow:false, yshift:-14, xanchor:'right', font:{size:12, color:'#1b2a3d'}}
    ],
    legend:{orientation:'h', x:0.5, y:1.04, xanchor:'center', bgcolor:'rgba(0,0,0,0)'}
  };

  Plotly.react('chart', [buildTrace(pos,'--purple'), buildTrace(neg,'--teal')], layout, {displayModeBar:false});
}

// init
render();
document.getElementById('metricList').addEventListener('change', render);
</script>
</body>
</html>
